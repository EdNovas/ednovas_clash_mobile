name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'main'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.0.1)'
        required: false
        default: 'dev'

env:
  GO_VERSION: '1.22'
  FLUTTER_VERSION: '3.24.x'
  NDK_VERSION: 'r26b'

jobs:
  build-core:
    name: Build Clash Core Libraries
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache-dependency-path: core/go.sum
    
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: ${{ env.NDK_VERSION }}
        add-to-path: true
    
    - name: Build Core Libraries
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        cd core
        
        # Define build targets
        declare -A TARGETS=(
          ["arm64-v8a"]="arm64:aarch64-linux-android21-clang"
          ["armeabi-v7a"]="arm:armv7a-linux-androideabi21-clang:7"
          ["x86_64"]="amd64:x86_64-linux-android21-clang"
        )
        
        TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
        
        for ABI in "${!TARGETS[@]}"; do
          IFS=':' read -r GOARCH CC_NAME GOARM <<< "${TARGETS[$ABI]}"
          
          echo "Building for $ABI (GOARCH=$GOARCH)..."
          
          OUTPUT_DIR="../android/app/src/main/jniLibs/$ABI"
          mkdir -p "$OUTPUT_DIR"
          
          export CGO_ENABLED=1
          export GOOS=android
          export GOARCH=$GOARCH
          export CC="$TOOLCHAIN/bin/$CC_NAME"
          
          if [ -n "$GOARM" ]; then
            export GOARM=$GOARM
          fi
          
          go build -v \
            -buildmode=c-shared \
            -tags "with_gvisor,cmfa" \
            -ldflags="-s -w" \
            -o "$OUTPUT_DIR/libclash.so" \
            .
          
          unset GOARM
          echo "âœ“ Built $ABI"
        done
        
        echo "All core libraries built successfully!"
    
    - name: Upload Core Libraries
      uses: actions/upload-artifact@v4
      with:
        name: core-libraries
        path: android/app/src/main/jniLibs/
        retention-days: 1

  build-apk:
    name: Build Android APK
    needs: build-core
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download Core Libraries
      uses: actions/download-artifact@v4
      with:
        name: core-libraries
        path: android/app/src/main/jniLibs/
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Get Dependencies
      run: flutter pub get
    
    - name: Generate App Icons
      run: dart run flutter_launcher_icons
    
    - name: Setup Keystore
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
      run: |
        # Setup google-services.json FIRST (required for build)
        if [ ! -z "$GOOGLE_SERVICES_JSON" ]; then
            echo "$GOOGLE_SERVICES_JSON" | base64 -d > android/app/google-services.json
            echo "âœ“ google-services.json configured"
        else
            echo "âš ï¸ No google-services.json configured, build may fail"
        fi
        
        # Only setup keystore if secrets are configured
        if [ -z "$KEYSTORE_BASE64" ]; then
          echo "âš ï¸ No keystore configured, using debug signing"
          exit 0
        fi
        
        # Decode keystore from base64
        echo "$KEYSTORE_BASE64" | base64 -d > android/app/ednovas-release-key.jks
        
        # Create key.properties
        cat > android/key.properties << EOF
        storePassword=$STORE_PASSWORD
        keyPassword=$KEY_PASSWORD
        keyAlias=$KEY_ALIAS
        storeFile=ednovas-release-key.jks
        EOF
        
        echo "âœ“ Keystore configured for release signing"
    
    - name: Build Release APK
      run: flutter build apk --release --split-per-abi
    
    - name: Build Universal APK
      run: flutter build apk --release
    
    - name: Rename APKs
      run: |
        VERSION="${GITHUB_REF_NAME:-${{ github.event.inputs.version }}}"
        VERSION="${VERSION#v}"  # Remove 'v' prefix if present
        
        mkdir -p release
        
        # Rename split APKs
        mv build/app/outputs/flutter-apk/app-arm64-v8a-release.apk \
           release/EdNovas-Clash-v${VERSION}-arm64-v8a.apk || true
        mv build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk \
           release/EdNovas-Clash-v${VERSION}-armeabi-v7a.apk || true
        mv build/app/outputs/flutter-apk/app-x86_64-release.apk \
           release/EdNovas-Clash-v${VERSION}-x86_64.apk || true
        
        # Rename universal APK
        mv build/app/outputs/flutter-apk/app-release.apk \
           release/EdNovas-Clash-v${VERSION}-universal.apk || true
        
        ls -la release/
    
    - name: Upload APK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: apk-release
        path: release/*.apk
        retention-days: 5

  build-ios-core:
    name: Build iOS Core Framework
    runs-on: macos-latest
    # TODO: iOS core build is temporarily disabled due to gomobile compatibility issues
    # Re-enable when gomobile bind package issue is resolved
    if: false  # Temporarily disabled
    continue-on-error: true
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        cache-dependency-path: core/go.sum
    
    - name: Install gomobile
      run: |
        # Set up GOPATH
        export GOPATH=$HOME/go
        export PATH=$PATH:$GOPATH/bin
        
        # Clone golang.org/x/mobile to ensure bind package is available
        mkdir -p $GOPATH/src/golang.org/x
        cd $GOPATH/src/golang.org/x
        git clone https://github.com/golang/mobile.git
        cd mobile
        
        # Install gomobile and gobind from source
        go install ./cmd/gomobile
        go install ./cmd/gobind
        
        # Initialize gomobile
        gomobile init
        
        echo "âœ… gomobile initialized from source"
        which gomobile
        which gobind
    
    - name: Build iOS Framework
      run: |
        export GOPATH=$HOME/go
        export PATH=$PATH:$GOPATH/bin
        
        cd core/ios
        
        # Use the cloned mobile package
        go mod edit -replace golang.org/x/mobile=$GOPATH/src/golang.org/x/mobile
        
        # Download all dependencies
        go mod tidy
        go mod download
        
        mkdir -p ../../ios/Frameworks
        
        # Build with verbose output for debugging
        gomobile bind \
          -v \
          -target=ios \
          -tags "with_gvisor" \
          -ldflags="-s -w" \
          -o ../../ios/Frameworks/Clashcore.xcframework \
          .
        
        echo "âœ… Clashcore.xcframework built successfully!"
        ls -la ../../ios/Frameworks/
    
    - name: Upload iOS Core Framework
      uses: actions/upload-artifact@v4
      with:
        name: ios-core-framework
        path: ios/Frameworks/
        retention-days: 1

  build-ipa:
    name: Build iOS IPA
    # Using pre-built Clashcore.xcframework from repository
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Verify iOS Core Framework
      run: |
        if [ -d "ios/Clashcore.xcframework" ]; then
          echo "âœ… Clashcore.xcframework found"
          ls -la ios/Clashcore.xcframework/
        else
          echo "âŒ Clashcore.xcframework not found!"
          exit 1
        fi
    
    - name: Select Xcode Version
      run: |
        sudo xcode-select --print-path
        xcodebuild -version
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Get Dependencies
      run: flutter pub get
    
    - name: Setup iOS Signing
      env:
        IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
        IOS_EXTENSION_PROFILE_BASE64: ${{ secrets.IOS_EXTENSION_PROFILE_BASE64 }}
        IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
      run: |
        # Skip if no iOS secrets configured
        if [ -z "$IOS_CERTIFICATE_BASE64" ]; then
          echo "âš ï¸ No iOS signing configured, skipping IPA build"
          echo "SKIP_IOS=true" >> $GITHUB_ENV
          exit 0
        fi
        
        # Create temporary keychain
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        security create-keychain -p "$IOS_KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$IOS_KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        
        # Import certificate
        echo "$IOS_CERTIFICATE_BASE64" | base64 -d > $RUNNER_TEMP/certificate.p12
        security import $RUNNER_TEMP/certificate.p12 -P "$IOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH
        
        # Install provisioning profiles
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        
        # Main app profile
        echo "$IOS_PROVISION_PROFILE_BASE64" | base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/main.mobileprovision
        echo "âœ… Main app profile installed"
        
        # Extension profile (if provided)
        if [ ! -z "$IOS_EXTENSION_PROFILE_BASE64" ]; then
          echo "$IOS_EXTENSION_PROFILE_BASE64" | base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/extension.mobileprovision
          echo "âœ… Extension profile installed"
        fi
        
        echo "âœ… iOS signing configured"
    
    - name: Build iOS Release
      if: env.SKIP_IOS != 'true'
      run: |
        # Build iOS app (Flutter handles code signing via Xcode)
        flutter build ios --release --no-codesign
        
        echo "âœ… iOS build completed"
    
    - name: Archive and Export IPA
      if: env.SKIP_IOS != 'true'
      env:
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        VERSION="${GITHUB_REF_NAME:-${{ github.event.inputs.version }}}"
        VERSION="${VERSION#v}"
        
        cd ios
        
        # Get main profile UUID
        MAIN_PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/main.mobileprovision
        MAIN_PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i "$MAIN_PROFILE_PATH"))
        echo "Main Profile UUID: $MAIN_PROFILE_UUID"
        
        # Get extension profile UUID (if exists)
        EXT_PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/extension.mobileprovision
        if [ -f "$EXT_PROFILE_PATH" ]; then
          EXT_PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i "$EXT_PROFILE_PATH"))
          echo "Extension Profile UUID: $EXT_PROFILE_UUID"
        fi
        
        # Create archive with signing
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -archivePath build/Runner.xcarchive \
          archive \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
          PROVISIONING_PROFILE_SPECIFIER="$MAIN_PROFILE_UUID" \
          -destination "generic/platform=iOS"
        
        # Export IPA
        mkdir -p ../release
        
        # Create export options plist
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>destination</key>
            <string>upload</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
                <key>com.ednovas.ednovasClashMobile</key>
                <string>EdNovas Clash Dist</string>
                <key>com.ednovas.ednovasClashMobile.PacketTunnel</key>
                <string>EdNovas PacketTunnel Dist</string>
            </dict>
        </dict>
        </plist>
        EOF
        
        xcodebuild -exportArchive \
          -archivePath build/Runner.xcarchive \
          -exportPath ../release \
          -exportOptionsPlist ExportOptions.plist
        
        # Rename IPA
        mv ../release/Runner.ipa ../release/EdNovas-Clash-v${VERSION}-ios.ipa || true
        
        echo "âœ… IPA exported"
        ls -la ../release/
    
    - name: Upload to TestFlight
      if: env.SKIP_IOS != 'true' && github.ref_type == 'tag'
      env:
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
      run: |
        # Skip if no API key configured
        if [ -z "$APP_STORE_CONNECT_API_KEY_ID" ]; then
          echo "âš ï¸ No App Store Connect API key configured, skipping TestFlight upload"
          exit 0
        fi
        
        # Decode API key
        echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 -d > AuthKey.p8
        
        # Find IPA file
        IPA_PATH=$(find release -name "*.ipa" | head -1)
        
        if [ -z "$IPA_PATH" ]; then
          echo "âŒ No IPA file found"
          exit 1
        fi
        
        echo "ğŸ“¤ Uploading $IPA_PATH to TestFlight..."
        
        # Upload using xcrun altool
        xcrun altool --upload-app \
          --type ios \
          --file "$IPA_PATH" \
          --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
          --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID" \
          --verbose
        
        echo "âœ… Uploaded to TestFlight!"
    
    - name: Upload IPA Artifact
      if: env.SKIP_IOS != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ipa-release
        path: release/*.ipa
        retention-days: 5

  release:
    name: Create GitHub Release
    needs: [build-apk, build-ipa]
    if: always() && needs.build-apk.result == 'success' && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Download APK Artifacts
      uses: actions/download-artifact@v4
      with:
        name: apk-release
        path: release/
    
    - name: Download IPA Artifacts
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: ipa-release
        path: release/
    
    - name: Generate Changelog
      id: changelog
      run: |
        # Get the previous tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        # Generate changelog
        if [ -z "$PREV_TAG" ]; then
          CHANGELOG="- ğŸ‰ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ"
        else
          CHANGELOG=$(git log --pretty=format:"- %s" $PREV_TAG..HEAD 2>/dev/null | head -30)
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- ğŸ”§ å°ä¿®å¤å’Œæ”¹è¿›"
          fi
        fi
        
        # Output using heredoc for multi-line
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Debug output
        echo "=== Generated Changelog ==="
        echo "$CHANGELOG"
    
    - name: Update README Version Badge
      run: |
        VERSION="${GITHUB_REF_NAME}"
        # Update version badge in README.md
        sed -i "s|version-v[0-9]*\.[0-9]*\.[0-9]*-blue|version-${VERSION}-blue|g" README.md
        
        # Check if there are changes
        if git diff --quiet README.md; then
          echo "No version changes in README"
        else
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: update version badge to ${VERSION}"
          git push origin HEAD:main || echo "Could not push to main, continuing..."
        fi
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: EdNovasäº‘ ${{ github.ref_name }}
        body: |
          ## ğŸ“¥ ä¸‹è½½åœ°å€ / Downloads
          
          æ³¨æ„ / Note: è¯·æ ¹æ®æ‚¨çš„è®¾å¤‡æ¶æ„é€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ã€‚å¦‚æœ‰é—®é¢˜ï¼Œè¯·å°è¯•å¸è½½æ—§ç‰ˆæœ¬åé‡è£…ã€‚
          
          ### ğŸ¤– Android
          
          | ç‰ˆæœ¬ | æ¶æ„ | é€‚ç”¨è®¾å¤‡ | ä¸‹è½½ (Download) |
          |------|------|----------|-----------------|
          | å®‰è£…åŒ… (æ¨è) | arm64-v8a | å¤§å¤šæ•°ç°ä»£æ‰‹æœº | [å®˜æ–¹](https://github.com/EdNovas/ednovas_clash_mobile/releases/download/${{ github.ref_name }}/EdNovas-Clash-${{ github.ref_name }}-arm64-v8a.apk) / [åŠ é€Ÿ](https://github.ednovas.xyz/https://github.com/EdNovas/ednovas_clash_mobile/releases/download/${{ github.ref_name }}/EdNovas-Clash-${{ github.ref_name }}-arm64-v8a.apk) |
          | å®‰è£…åŒ… | armeabi-v7a | è¾ƒæ—§çš„ 32 ä½æ‰‹æœº | [å®˜æ–¹](https://github.com/EdNovas/ednovas_clash_mobile/releases/download/${{ github.ref_name }}/EdNovas-Clash-${{ github.ref_name }}-armeabi-v7a.apk) / [åŠ é€Ÿ](https://github.ednovas.xyz/https://github.com/EdNovas/ednovas_clash_mobile/releases/download/${{ github.ref_name }}/EdNovas-Clash-${{ github.ref_name }}-armeabi-v7a.apk) |
          | å®‰è£…åŒ… | x86_64 | æ¨¡æ‹Ÿå™¨ã€éƒ¨åˆ†å¹³æ¿ | [å®˜æ–¹](https://github.com/EdNovas/ednovas_clash_mobile/releases/download/${{ github.ref_name }}/EdNovas-Clash-${{ github.ref_name }}-x86_64.apk) / [åŠ é€Ÿ](https://github.ednovas.xyz/https://github.com/EdNovas/ednovas_clash_mobile/releases/download/${{ github.ref_name }}/EdNovas-Clash-${{ github.ref_name }}-x86_64.apk) |
          | é€šç”¨åŒ… | å…¨æ¶æ„ | æ‰€æœ‰è®¾å¤‡ï¼ˆæ–‡ä»¶è¾ƒå¤§ï¼‰ | [å®˜æ–¹](https://github.com/EdNovas/ednovas_clash_mobile/releases/download/${{ github.ref_name }}/EdNovas-Clash-${{ github.ref_name }}-universal.apk) / [åŠ é€Ÿ](https://github.ednovas.xyz/https://github.com/EdNovas/ednovas_clash_mobile/releases/download/${{ github.ref_name }}/EdNovas-Clash-${{ github.ref_name }}-universal.apk) |
          
          ### ğŸ iOS
          
          | ç‰ˆæœ¬ | è¯´æ˜ | ä¸‹è½½ |
          |------|------|------|
          | IPA (æœªç­¾å) | éœ€è¦è‡ªç­¾æˆ– AltStore å®‰è£… | [å®˜æ–¹](https://github.com/EdNovas/ednovas_clash_mobile/releases/download/${{ github.ref_name }}/EdNovas-Clash-${{ github.ref_name }}-ios-unsigned.ipa) / [åŠ é€Ÿ](https://github.ednovas.xyz/https://github.com/EdNovas/ednovas_clash_mobile/releases/download/${{ github.ref_name }}/EdNovas-Clash-${{ github.ref_name }}-ios-unsigned.ipa) |
          
          ---
          
          ### ğŸ”„ å˜æ›´æ—¥å¿— / Changelog
          
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ---
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - æœ¬åº”ç”¨ä¸º EdNovas è®¢é˜…æœåŠ¡ä¸“å± VPN å®¢æˆ·ç«¯
          - éœ€è¦æœ‰æ•ˆçš„ EdNovas è´¦å·æ‰èƒ½ä½¿ç”¨
          - é¦–æ¬¡ä½¿ç”¨è¯·å…ˆåœ¨è®¾ç½®ä¸­ç™»å½•è´¦å·
        files: release/*
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
